# Ralph Demo - Progress Log

## Project Overview
This project demonstrates migrating a legacy Java enum (LegacyTargetCode) to a string-based
data class (TargetKey). The enum has 12 values with two constructor shapes (2-param core targets
and 5-param suite targets) and is used across 14 files in the codebase. The migration must be
incremental, test-driven, and backward-compatible at every step.

## Codebase Patterns
- Package: com.demo.obfuscated
- Java 17
- JUnit 5 for testing
- Gradle build system

## Project Boundaries
- The app code and tests are at repository root under `src/**`.
- Ralph loop control artifacts are in `ralph_demo` (`prd.json`, `progress.txt`, `prompt.md`, `ralph.sh`).
- Execute from `ralph_demo`; migration edits target `../src/main/java/com/demo/obfuscated/**` and tests in `../src/test/java/com/demo/obfuscated/**`.
- Verification command for the demo is `../gradlew test`.

## Key Files
- ../src/main/java/com/demo/obfuscated/LegacyTargetCode.java - Enum to migrate away from
- ../src/main/java/com/demo/obfuscated/RuleStrategy.java - Interface, returns enum
- ../src/main/java/com/demo/obfuscated/BaseRuleStrategy.java - Abstract base, holds enum
- ../src/main/java/com/demo/obfuscated/ThresholdRuleStrategy.java - Strategy impl, uses enum
- ../src/main/java/com/demo/obfuscated/ExpressionRuleStrategy.java - Strategy impl, uses enum
- ../src/main/java/com/demo/obfuscated/RolloutRuleStrategy.java - Strategy impl, uses enum
- ../src/main/java/com/demo/obfuscated/RuleBuilder.java - Builder interface, accepts enum
- ../src/main/java/com/demo/obfuscated/RuleBuilderImpl.java - Builder impl, holds enum
- ../src/main/java/com/demo/obfuscated/RuleStrategySerializer.java - Serializes using enum name
- ../src/main/java/com/demo/obfuscated/RuleStrategyDeserializer.java - Deserializes via valueOf
- ../src/main/java/com/demo/obfuscated/RuleValidationService.java - Validates using enum identity checks
- ../src/main/java/com/demo/obfuscated/WebhookHandler.java - Routes by enum map keys
- ../src/main/java/com/demo/obfuscated/FeatureToggleAdapter.java - Toggle logic using enum
- ../src/main/java/com/demo/obfuscated/TenantConfigLoader.java - Resolves enum from strings
- ../src/main/java/com/demo/obfuscated/TargetHandler.java - Categorizes using enum identity

## Enum Shape
Core targets (2-param): LegacyTargetCode(value, tenant)
Suite targets (5-param): LegacyTargetCode(account, project, value, environmentId, tenant)

## Learnings
(Agent will append learnings here after each story)

## Talk Track Checkpoints
1) Foundation checkpoint (US-001 to US-003)
- Introduce TargetKey, repository lookup model, and canonical conversion contracts.
- Demo artifact: passing tests for TargetKey behavior and enum/TargetKey round-trip conversion.

2) First integration checkpoint (US-004 to US-005)
- Surface TargetKey through strategy and builder APIs while keeping enum callers working.
- Demo artifact: compatibility-focused strategy and builder tests remain green.

3) Compatibility checkpoint (US-006 to US-008)
- Expand migration into serializer/deserializer, validation, webhook, adapter, loader, and handler paths.
- Demo artifact: tests prove both legacy and new payload/lookup paths work.

4) Deprecation checkpoint (US-009)
- Mark LegacyTargetCode as deprecated with migration guidance and prevent new active usage.
- Demo artifact: all tests pass with deprecation state in place.

## Loop Execution Sizing Notes
- Stories are intentionally scoped to one seam each (data model, conversion, interface, serialization, integration, deprecation).
- Priorities are dependency-safe: foundations (P1/P2) precede broad integration (P3) and deprecation (P4).
- `passes` remains binary per story and should be flipped only after `../gradlew test` is green.

## US-001 - Create TargetKey data class
- Created TargetKey class with value, account, project, environmentId, and tenant fields.
- Implemented equals/hashCode and toString.
- Implemented getValueWithProject().
- Verified with unit tests and ensured existing tests pass.

## US-002 - Create TargetRepository interface and in-memory implementation
- Created TargetRepository interface with lookup methods.
- Implemented InMemoryTargetRepository seeding from LegacyTargetCode.
- Added unit tests for all lookup paths including unknown targets.
- Verified with tests.

## US-003 - Add conversion methods to LegacyTargetCode
- Added conversion methods to LegacyTargetCode enum.
- Created TargetConverter utility class.
- Added unit tests for round-trip conversions and unknown inputs.
- Verified with tests.

## US-004 - Add string-based target getter to RuleStrategy interface
- Added getTargetKey() and getTargetValue() to RuleStrategy interface.
- Updated BaseRuleStrategy and concrete strategies to support TargetKey constructors.
- Fixed null ambiguity in existing tests by explicit casting.
- Added RuleStrategyTargetKeyTest to verify new functionality.
- Verified with all tests passing.

## US-005 - Update RuleBuilder with TargetKey support
- Added withTargetKey(TargetKey) to RuleBuilder interface.
- Updated RuleBuilderImpl to support building from TargetKey.
- Added RuleBuilderTest to verify enum and TargetKey builder paths.
- Verified with all tests passing.

## US-006 - Update serializer and deserializer for backward compatibility
- Updated RuleStrategySerializer to write all TargetKey fields.
- Updated RuleStrategyDeserializer to read TargetKey fields and support legacy enum format.
- Handled empty fields as null in deserializer to ensure TargetKey equality.
- Added round-trip and backward compatibility tests.
- Verified with all tests passing.

## US-007 - Migrate RuleValidationService and WebhookHandler to use string-based targets
- Migrated RuleValidationService to use TargetKey and value-based checks.
- Migrated WebhookHandler to use TargetKey in its internal map.
- Added TargetKey overloads to WebhookHandler and fixed null ambiguities in tests.
- Verified with all tests passing.

## US-008 - Migrate FeatureToggleAdapter and TenantConfigLoader
- Updated FeatureToggleAdapter to use TargetKey and added overloads.
- Updated TenantConfigLoader resolve methods to return TargetKey.
- Updated TargetHandler to use TargetKey and added overloads.
- Fixed tests to use TargetKey types.
- Verified with all tests passing.

## US-009 - Deprecate LegacyTargetCode enum
- Added @Deprecated to LegacyTargetCode enum and all methods using it.
- Added deprecation Javadoc with migration instructions.
- Verified that all tests pass.
